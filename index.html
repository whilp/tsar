<!DOCTYPE html> 
<html lang="en"> 
 
<head> 
  <meta charset="utf-8" /> 
  <title>dcache iowait</title> 
  <link rel="stylesheet" href="../../style.css" /> 
  <!--[if IE]>
  <script language="javascript" type="text/javascript" src="../../js/excanvas.min.js"></script>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <script src="http://www.google.com/jsapi"></script>
  <script>
    google.load("jquery", "1.4.2");
  </script>
  <script src="../../js/jquery.flot.min.js"></script>
  <script src="../../js/jquery.flot.selection.min.js"></script>

  <style>
  p {
    margin-top: 1em;
    margin-bottom: 1em;
  }
  </style>
</head> 
 
<body> 
  <h1>iowait patterns on cmsdcache01 (July/August, 2010)</h1>
  <div id="iowait" class="plot"></div>
  <div id="iowait-overview" class="overview"></div>

  <div id="pnfsman" class="plot"></div>
  <div id="pnfsman-overview" class="overview"></div>

  <p>This plot shows various types of system load on our dCache PNFS headnode, sampled 
  at ten minute intervals by <tt>sar(1)</tt> (all times UTC). Note: you can select 
  ranges on the x axis of either the detailed or summary plots to zoom.
  </p>

  <p>The <a href="iowait.raw">data</a> was produced with a 
  <a href="update-data.sh">small wrapper around sar</a> and then converted to 
  <a href="iowait.json">JSON</a> using <a href="sar2json.py">Python</a>.
  </p>

  <p>At about 19:20 UTC on August 04, we reconfigured the Postgres backend on 
  this server to use higher <tt>bgwriter*</tt> parameters, hoping to reduce the IO
  required during database checkpoints.
  </p>

  <p>At about 15:30 UTC on August 05, we again reconfigured the Postgres
  database, this time increasing the amount of memory dedicated to its
  <tt>shared_buffers</tt>.
  </p>

  <script>
  $(function () {
    function plot (placeholder, options) {
      var options = $.extend({}, {
          queries: [],
          lines: {show: true},
          selection: { mode: "x" },
          xaxis: { mode: "time" },
          // colors: [ "#aaa", "#666", "#333", "#111" ],
      }, options);
      var overviewopts = $.extend({}, options, {
          lines: { lineWidth: 1 },
          shadowSize: 0,
          yaxis: { ticks: [], min: 0, autoscaleMargin: 0.1 },
          legend: { show: false },
      }, options.overview);

      var plotplaceholder = $(placeholder);
      var viewplaceholder = false;
      if (options.overview && options.overview.placeholder) {
        var viewplaceholder = $(options.overview.placeholder);
      };

      var seriesopts = {};
      function encodeid (subject, attribute, cf) {
        return [subject, attribute, cf].join("/");
      };
      $.each(options.queries, function (i, query) {
        var key = encodeid(query.subject, query.attribute, query.cf);
        seriesopts[key] = query.options;
        delete query.options;
      });

      function render (json) {
        var data = [];
        $.each(json, function (s, series) {
          for (var i = 0; i < series.length; ++i) {
              series[i][0] *= 1000;
          };
          data.push($.extend({data: series}, {label: s}, seriesopts[s]));
        });

        var plot = $.plot(plotplaceholder, data, options);
        if (viewplaceholder) {
          var overview = $.plot(viewplaceholder, data, overviewopts);

          plotplaceholder.bind("plotselected", function (event, ranges) {
            plot = $.plot(plotplaceholder, data,
                $.extend(true, {}, options, {
                    xaxis: { min: ranges.xaxis.from, max: ranges.xaxis.to },
                    bars: { 
                      barWidth: 
                        10 * ((ranges.xaxis.from - ranges.xaxis.to)/plotplaceholder.width()),
                    },
                }))
            overview.setSelection(ranges, true);
          });

          viewplaceholder.bind("plotselected", function (event, ranges) {
            plot.setSelection(ranges);
          });
        };
      };

      function paramify (k, v) {
          return "&" + encodeURIComponent(k) + "=" + encodeURIComponent(v);
      };

      function querify (queries) {
          var url = "";
          $.each(queries, function (i, query) {
              url += paramify("subject", query.subject);
              delete query.subject;
              $.each(query, function (k, v) { url += paramify(k, v); });
          });

          return url;
      };

      var url = options.service + "?_accept=application/json&callback=?&missing=skip";
      url += querify(options.queries);

      $.ajax({
          url: url,
          success: render,
          method: "GET",
          dataType: "jsonp",
      });

      return plotplaceholder;
    };

    var options = {
      service: "http://tsar.hep.wisc.edu/records",
    };
    var common = { cf: "max", interval: 60 };

    var iowait = plot("#iowait", $.extend({}, options, {
      queries: [
          $.extend({}, common, 
            { subject: "cmsdcache01.hep.wisc.edu", attribute: "cpu_iowait_pct", 
              options: { label: "iowait load (%)" }}),
          $.extend({}, common, 
            { subject: "cmsdcache01.hep.wisc.edu", attribute: "cpu_system_pct",
              options: { label: "system load (%)" }}),
          $.extend({}, common, 
            { subject: "cmsdcache01.hep.wisc.edu", attribute: "cpu_user_pct",
              options: { label: "user load (%)" }}),
      ],
      overview: {
        placeholder: "#iowait-overview",
      },
    }));
    var pnfsman = plot("#pnfsman", $.extend({}, options, {
        queries: [
            $.extend({}, common, 
              { subject: "dcache_pnfsmanager", attribute: "queue_depth",
                options: { label: "queue depth", yaxis: 1 }}),
            $.extend({}, common, 
              { subject: "dcache_pnfsmanager", attribute: "failrate_total",
                options: { label: "message fail rate (%)", yaxis: 2 }}),
        ],
        yaxes: [ {}, { position: "right" } ],
        overview: {
          placeholder: "#pnfsman-overview",
        },
    }));
  });

  </script>
</body>
</html>
